parameters:
  WebAppName: ''
  AzureSubscription: ''
  FunctionAppDomain: ''
  PackageFile: ''
  ResourceGroup: ''
  SharedResourceGroup: ''
  ApimServiceName: ''
  ApimProductName: ''
  ApimApiName: ''
  SolutionBaseName: ''


steps:
- checkout: mon-devops
  path: 's/mon-devops/'

- task: AzureRmWebAppDeployment@4
  displayName: 'Azure App Service Deploy: ${{ parameters.WebAppName }}'
  inputs:
    azureSubscription: '${{ parameters.AzureSubscription }}'
    appType: functionApp
    WebAppName: '${{ parameters.WebAppName }}'
    Package: "${{ parameters.PackageFile }}"
    deployToSlotOrASE: false
    ResourceGroupName: '${{ parameters.ResourceGroup }}'

- task: AzureCLI@2
  displayName: 'Switch off authentication'
  inputs:
    azureSubscription: '${{ parameters.AzureSubscription }}'
    scriptType: ps
    scriptPath: '$(Pipeline.Workspace)/${{ parameters.SolutionBaseName }}.Scripts/Toggle-AppAuthentication.ps1'
    arguments: ' -ResourceGroup ${{ parameters.ResourceGroup }} -FunctionAppName ${{ parameters.WebAppName }} -Toggle $False -Verbose'

- task: AzurePowerShell@4
  displayName: 'Import OpenAPI specification'
  inputs:
    azureSubscription: '${{ parameters.AzureSubscription }}'
    ScriptPath: '$(Agent.BuildDirectory)/s/mon-devops//PSCoreScripts/Import-ApimSwaggerApiDefinition.ps1'
    ScriptArguments: ' -ApimResourceGroup ${{ parameters.SharedResourceGroup }} -InstanceName ${{ parameters.ApimServiceName }} -ApiName ${{ parameters.ApimProductName }}-${{ parameters.ApimApiName }} -ApiPath ${{ parameters.ApimProductName }}/${{ parameters.ApimApiName }} -SwaggerSpecificationUrl https://${{ parameters.WebAppName }}.${{ parameters.FunctionAppDomain }}/swagger/json -OutputFilePath $(Agent.BuildDirectory)/SwaggerFile -Verbose'
    azurePowerShellVersion: LatestVersion

- task: AzureCLI@2
  displayName: 'Switch on authentication'
  inputs:
    azureSubscription: '${{ parameters.AzureSubscription }}'
    scriptType: ps
    scriptPath: '$(Pipeline.Workspace)/${{ parameters.SolutionBaseName }}.Scripts/Toggle-AppAuthentication.ps1'
    arguments: ' -ResourceGroup ${{ parameters.ResourceGroup }} -FunctionAppName ${{ parameters.WebAppName }} -Toggle $True -Verbose'

